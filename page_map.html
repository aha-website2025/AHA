<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Map | Affordable Housing Atlas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css_style.css" />
  <link rel="stylesheet" href="css_map.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { 
      height: 80vh; 
      width: 100%; 
    }
    
    /* Ensure controls and menu are above map */
    .map-page .controls {
      position: relative;
      z-index: 2000;
    }
    
    .map-page .menu {
      z-index: 2000;
    }
    
    .map-page .filter-menu {
      z-index: 2001;
    }
    
    .leaflet-popup-content-wrapper {
      border-radius: 0;
      box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content {
      margin: 12px;
      max-width: 220px;
      font-family: sans-serif;
      width: 220px;
    }
    .leaflet-popup-content h3 {
      margin: 0 0 4px 0;
      font-size: 15px;
      font-weight: bold;
    }
    .leaflet-popup-content p {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #666;
    }
    .leaflet-popup-content img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 0;
      display: block;
    }
    .leaflet-popup-tip {
      border-radius: 0;
    }
    .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      border: none;
      background: none;
      font-size: 24px;
      cursor: pointer;
      color: #333;
      line-height: 1;
      padding: 0;
      width: 24px;
      height: 24px;
    }
    
    .reset-view-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      color: #4a4a4a;
      cursor: pointer;
      font-family: sans-serif;
      backdrop-filter: blur(5px);
    }
    
    .reset-view-btn:hover {
      background: #f4f4f4;
    }
    
    .leaflet-control-layers {
      margin-top: 50px !important;
    }
    
    /* Hover preview card styling */
    .hover-preview-card .leaflet-popup-content-wrapper {
      background: white;
      border-radius: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 0;
    }
    
    .hover-preview-card .leaflet-popup-content {
      margin: 0;
      padding: 0;
      width: 200px;
      max-width: 200px;
    }
    
    .hover-preview-card .leaflet-popup-tip {
      border-radius: 0;
    }
    
    .hover-card-content {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .hover-card-content img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }
    
    .hover-card-info {
      padding: 6px 10px;
      background: white;
    }
    
    .hover-card-info h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      font-weight: bold;
      color: #333;
      font-family: sans-serif;
    }
    
    .hover-card-info p {
      margin: 0;
      font-size: 12px;
      color: #666;
      font-family: sans-serif;
    }
  </style>
</head>
<body class="map-page home-page">
  <header class="site-header">
    <a href="index.html">
      <img src="graphics/Logo.png" alt="Affordable Housing Atlas Logo" class="logo" />
    </a>
  </header>

  

  <nav class="menu">
    <div class="hamburger black" onclick="toggleMenu()"></div>
    <ul class="menu-items" id="menuItems">
      <li><a href="index.html">Projects</a></li>
      <li><a href="page_models.html">Models</a></li>
      <li><a href="page_map.html">Map</a></li>
      <li><a href="page_about.html">About</a></li>
    </ul>
  </nav>

  <!-- Controls: filters and search -->
  <div class="controls">
    <!-- Filter Bar -->
    <div id="filters" class="filters">
      <div class="filters-primary">
        <div class="filter-group" data-key="typology">
          <button class="filter-toggle" type="button">Typology</button>
          <div class="filter-menu"></div>
        </div>

        <div class="filter-group" data-key="material">
          <button class="filter-toggle" type="button">Material</button>
          <div class="filter-menu"></div>
        </div>

        <div class="filter-group" data-key="model">
          <button class="filter-toggle" type="button">Model</button>
          <div class="filter-menu"></div>
        </div>
      </div>

      <button id="clearFilters" class="clear-filters" type="button">Clear</button>
    </div>

    <!-- Search (now under the filters) -->
    <div class="search-row">
      <input
        type="text"
        id="searchInput"
        placeholder="Search"
      />
    </div>
  </div>

  <div class="map">
    <!-- These are the new divs for the custom corners -->
    <div class="corner corner-top-left"></div>
    <div class="corner corner-top-right"></div>
    <div class="corner corner-bottom-left"></div>
    <div class="corner corner-bottom-right"></div>
    <button class="reset-view-btn" onclick="resetMapView()">Reset View</button>
    <div id="map"></div>
  </div> 

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="filters.js"></script>
  <script>
    let map;
    let allMarkers = [];
    let currentPopup = null;
    let allProjects = [];

    // Create marker icons with different colors (squares)
    const createMarkerIcon = (color) => {
      return L.divIcon({
        className: 'custom-marker',
        html: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12">
                 <rect x="1" y="1" width="10" height="10" fill="${color}" stroke="#fff" stroke-width="1"/>
               </svg>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6],
      });
    };

    function initMap() {
      // Initialize map with world view (will auto-fit to markers after load)
      map = L.map('map', {
        layers: [] // Start with no layers
      }).setView([0, 0], 2);

      // Base layers
      const streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      });

      const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxZoom: 19
      });

      // Add street map by default
      streetMap.addTo(map);

      // Layer control
      const baseMaps = {
        "Street": streetMap,
        "Satellite": satelliteMap
      };

      L.control.layers(baseMaps, null, {
        position: 'topright'
      }).addTo(map);
      
      const darkGreyIcon = createMarkerIcon("#4a4a4a");

      // Load projects from JSON
      fetch("json_projects.json")
        .then(response => response.json())
        .then(data => {
          allProjects = data;
          
          console.log("Loaded projects:", allProjects.length);
          console.log("Projects with coordinates:", allProjects.filter(p => p.coordinates).length);
          
          // Initialize filters if available
          if (typeof initAHAFilters === 'function') {
            initAHAFilters({
              projects: allProjects,
              renderGrid: filterMapMarkers,
              gridSelector: "#map",
              infoPath: (slug) => `projects/${encodeURIComponent(slug)}/info.txt`
            });
          } else {
            console.warn("initAHAFilters not found, filters may not work");
          }
          
          // Function to parse info.txt
          const parseInfoTxt = (text) => {
            const lines = text.split(/\r?\n/);
            const info = {};
            lines.forEach(line => {
              const match = line.match(/^\s*([^:]+)\s*:\s*(.+)\s*$/);
              if (match) {
                const key = match[1].trim().toLowerCase().replace(/\s+/g, "_");
                info[key] = match[2].trim();
              }
            });
            return info;
          };

          // Create markers with model info
          data.forEach(async project => {
            if (!project.coordinates) {
              console.log("No coordinates for:", project.title);
              return;
            }

            const [lat, lng] = project.coordinates.split(",").map(Number);
            console.log("Creating marker for:", project.title, "at", lat, lng);

            // Fetch model info from info.txt
            let modelInfo = '';
            try {
              const infoResponse = await fetch(`projects/${encodeURIComponent(project.slug)}/info.txt`);
              const infoText = await infoResponse.text();
              const parsedInfo = parseInfoTxt(infoText);
              modelInfo = parsedInfo.model || '';
            } catch (e) {
              console.log("Could not load info for:", project.title);
            }

            const marker = L.marker([lat, lng], {
              icon: darkGreyIcon
            }).addTo(map);

            const popupContent = `
              <button class="close-btn" onclick="if(currentPopup) currentPopup.remove();">Ã—</button>
              <h3>${project.title}</h3>
              <p>${modelInfo}</p>
              <a href="page_project.html?slug=${project.slug}">
                <img src="${project.image}" alt="${project.title}" />
              </a>
            `;

            marker.bindPopup(popupContent, {
              maxWidth: 220,
              minWidth: 220,
              closeButton: false
            });

            marker.on('click', function(e) {
              // Close previous popup
              if (currentPopup && currentPopup !== e.target.getPopup()) {
                currentPopup.remove();
              }
              currentPopup = e.target.getPopup();
              
              // Zoom into the neighborhood
              map.flyTo(e.latlng, 15, {
                duration: 1.0 // Smooth animation over 1 second
              });
            });

            // Hover preview card
            const hoverCard = L.popup({
              closeButton: false,
              autoClose: false,
              closeOnClick: false,
              className: 'hover-preview-card',
              offset: [0, -5]
            }).setContent(`
              <div class="hover-card-content">
                <img src="${project.image}" alt="${project.title}" />
                <div class="hover-card-info">
                  <h4>${project.title}</h4>
                  <p>${modelInfo}</p>
                </div>
              </div>
            `);

            marker.on('mouseover', function(e) {
              hoverCard.setLatLng(e.latlng).openOn(map);
            });

            marker.on('mouseout', function(e) {
              map.closePopup(hoverCard);
            });

            marker.projectData = project;
            marker.projectCategory = project.category;
            allMarkers.push(marker);
          });
          
          // Fit map to show all markers
          if (allMarkers.length > 0) {
            const bounds = L.latLngBounds(allMarkers.map(m => m.getLatLng()));
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        });

      // Close popup on map click
      map.on('click', function() {
        if (currentPopup) {
          currentPopup.remove();
          currentPopup = null;
        }
      });
    }

    // Filter markers based on filtered projects from the filter system
    function filterMapMarkers(filteredProjects) {
      console.log("Filtering markers, filtered projects:", filteredProjects ? filteredProjects.length : "all");
      
      // If no filtered list provided OR all projects are included (no active filter)
      if (!filteredProjects || filteredProjects.length === allProjects.length) {
        allMarkers.forEach(marker => {
          marker.setIcon(createMarkerIcon("#4a4a4a"));
        });
        return;
      }
      
      // Create a Set of slugs from filtered projects for fast lookup
      const filteredSlugs = new Set(filteredProjects.map(p => p.slug));
      
      // Change marker colors based on filter status
      allMarkers.forEach(marker => {
        if (filteredSlugs.has(marker.projectData.slug)) {
          // Filtered projects: salmon-red
          marker.setIcon(createMarkerIcon("#fa8072"));
        } else {
          // Non-filtered projects: darker grey
          marker.setIcon(createMarkerIcon("#a0a0a0"));
        }
      });
    }

    function toggleMenu() {
      const menu = document.getElementById("menuItems");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function resetMapView() {
      // Close any open popup
      if (currentPopup) {
        currentPopup.remove();
        currentPopup = null;
      }
      // Fit map to show all markers
      if (allMarkers.length > 0) {
        const bounds = L.latLngBounds(allMarkers.map(m => m.getLatLng()));
        map.flyToBounds(bounds, { 
          padding: [50, 50],
          duration: 1.5
        });
      }
    }

    // Initialize map when page loads
    window.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
